下面给出**一期（3个小版本：v1.0 / v1.1 / v1.2）后端接口开发文档**，已**明确每个接口的入参与出参**、校验与权限。技术栈假定 **NestJS + TS + Prisma + MySQL**；仅列出需要开发的接口（不含代码）。

---

# 矩阵看板 · 后端接口开发文档（一期）

> 目标：支持“账号运营 → 转化提交 → 充值特征同步”闭环；并严格受 RBAC 控制。
> API 前缀：`/api`；认证：`Bearer <JWT>`；返回统一：`{ code, msg, data }`。
> 角色：
>
> * **SUPER\_ADMIN**（超管）
> * **CONVERSION\_ADMIN**（转化管理员）
> * **CONVERTER**（转化）
> * **OPERATOR**（账号运营）

---

## 0）统一约定

### 0.1 状态码与返回结构

* 成功：`code=200`；客户端错误：`400/422`；鉴权失败：`401`；权限不足：`403`；未找到：`404`；服务异常：`500`
* 错误返回：

```json
{ "code": 400, "msg": "phoneNo already exists", "data": null }
```

### 0.2 分页与搜索

* 入参：`page`（≥1，默认1），`pageSize`（1\~100，默认20），`q` 统一模糊搜索
* 列表返回：

```json
{
  "code": 200,
  "msg": "ok",
  "data": {
    "page": 1,
    "pageSize": 20,
    "total": 123,
    "items": [ /* 实体列表 */ ]
  }
}
```

### 0.3 RBAC/可见性（强约束）

* **OPERATOR** 仅可见 `ownerId=自己` 的账号及与之相关的数据
* **CONVERTER** 仅可见自己提交的转化记录（管理员类可见全量）
* 管理员类（SUPER\_ADMIN/CONVERSION\_ADMIN）可见/管理全量

---

## 1）公共/鉴权（全版本可用）

### 1.1 获取当前用户

**GET** `/auth/me`
**权限**：登录用户
**入参**：无
**出参**

```json
{
  "code": 200,
  "msg": "ok",
  "data": { "id": "u_1001", "username": "alice", "role": "OPERATOR", "teamId": "t_01" }
}
```

---

## 2）账号运营模块（v1.0）

### 2.1 创建账号（提交账号）

**POST** `/accounts`
**权限**：OPERATOR、管理员类
**入参（JSON）**

```json
{
  "phoneNo": "PH-0001",               // 必填，字符串，唯一；长度1~64
  "accountLink": "https://t.me/xxx",  // 必填，URL
  "ownerId": "u_1001"                 // 可选；OP创建不传则默认=自己；管理员可指定
}
```

**校验/规则**

* `phoneNo` 全局唯一；若存在返回 `400`
* `accountLink` 必须是 URL
* 记录 `createdBy` = 当前用户

**出参**

```json
{
  "code": 200,
  "msg": "ok",
  "data": {
    "id": "acc_123",
    "phoneNo": "PH-0001",
    "accountLink": "https://t.me/xxx",
    "ownerId": "u_1001",
    "createdBy": "u_1001",
    "status": "ACTIVE",
    "createdAt": "2025-09-03T03:20:00Z"
  }
}
```

### 2.2 账号列表（含模糊搜索）

**GET** `/accounts?q=&page=&pageSize=&ownerId=&createdBy=&createdAtStart=&createdAtEnd=`
**权限**：登录用户（OP 仅返回 ownerId=自己；管理员可查全量/按条件）
**入参（Query）**

* `q`：模糊匹配 `phoneNo`、`accountLink`
* `ownerId`、`createdBy`、`createdAtStart/End`：可选

**出参**（分页见 0.2；items 结构同 2.1 出参 `data`）

### 2.3 账号详情

**GET** `/accounts/:id`
**权限**：登录用户（OP 仅可查看归属自己的账号）
**入参**：`id` 路径参数
**出参**

```json
{
  "code": 200,
  "msg": "ok",
  "data": {
    "id": "acc_123",
    "phoneNo": "PH-0001",
    "accountLink": "https://t.me/xxx",
    "ownerId": "u_1001",
    "createdBy": "u_1001",
    "status": "ACTIVE",
    "createdAt": "2025-09-03T03:20:00Z",
    "stats": { "conversionCount": 5 },                 // 关联转化条数（可选）
    "lastRechargeFeature": {                           // v1.2 生效（可为空）
      "userId": 1002623,
      "features": { "isVip": true, "rechargeTotal": 120.5 },
      "lastSyncedAt": "2025-09-03T05:10:00Z",
      "source": "yaychat"
    }
  }
}
```

### 2.4 更新账号归属（仅管理员）

**PATCH** `/accounts/:id/owner`
**权限**：SUPER\_ADMIN、CONVERSION\_ADMIN
**入参（JSON）**

```json
{ "ownerId": "u_2002" }   // 必填，存在的用户ID
```

**出参**：与 2.3 相同结构（变更后的账号对象）
**备注**：需记录审计日志（旧owner→新owner、操作人、时间）

---

## 3）转化模块（v1.1）

### 3.1 提交转化（注册ID关联到账号/手机）

**POST** `/conversions`
**权限**：CONVERTER、管理员类
**入参（JSON）** （二选一：`accountId` 或 `phoneNo`）

```json
{
  "registerUserId": 1002623,    // 必填，正整数
  "accountId": "acc_123",       // 可选，和 phoneNo 互斥
  "phoneNo": "PH-0001"          // 可选，和 accountId 互斥
}
```

**校验/规则**

* 若传 `phoneNo`，后端需映射到唯一 `accountId`；找不到或多条返回 `422`
* 幂等：同一 `registerUserId + accountId` 只允许一条（重复返回 `200` 并附带已存在记录 OR 返回 `409`，按产品决定；推荐返回 `200` 并标记 `duplicated=true`）

**出参**

```json
{
  "code": 200,
  "msg": "ok",
  "data": {
    "id": "conv_001",
    "registerUserId": 1002623,
    "accountId": "acc_123",
    "phoneNo": "PH-0001",
    "createdBy": "u_3003",
    "createdAt": "2025-09-03T04:00:00Z",
    "duplicated": false
  }
}
```

### 3.2 转化列表（模糊搜索）

**GET** `/conversions?q=&page=&pageSize=&registerUserId=&phoneNo=&accountId=&createdBy=`
**权限**：登录用户（CONVERTER 默认仅看自己提交；管理员可全量）
**入参（Query）**

* `q`：模糊匹配 `registerUserId`、`phoneNo`、关联 `accountLink`
* 其他过滤：`registerUserId/phoneNo/accountId/createdBy`

**出参**（分页，items 结构同 3.1 出参 `data`）

### 3.3 转化详情

**GET** `/conversions/:id`
**权限**：登录用户（CONVERTER 仅看自己提交；管理员可看）
**出参**

```json
{
  "code": 200,
  "msg": "ok",
  "data": {
    "id": "conv_001",
    "registerUserId": 1002623,
    "accountId": "acc_123",
    "phoneNo": "PH-0001",
    "createdBy": "u_3003",
    "createdAt": "2025-09-03T04:00:00Z",
    "accountBrief": {
      "id": "acc_123",
      "phoneNo": "PH-0001",
      "accountLink": "https://t.me/xxx",
      "ownerId": "u_1001"
    },
    "lastRechargeFeature": {                    // v1.2 生效（可为空）
      "userId": 1002623,
      "features": { "isVip": true, "rechargeTotal": 120.5 },
      "lastSyncedAt": "2025-09-03T05:10:00Z",
      "source": "yaychat"
    }
  }
}
```

---

## 4）YayChat 充值特征同步（v1.2）

> 外部来源：`https://opadmin-api.yay.chat/user/means/get-user-recharge-feature?userIds=1002623,1002624,1002622`
> 特性：**服务端后端调用**；**批量**；与 Damon 同步字段语义与批量上限/QPS。

### 4.1 触发批量同步（管理端操作）

**POST** `/sync/recharge-features`
**权限**：SUPER\_ADMIN、CONVERSION\_ADMIN
**入参（JSON）**

```json
{
  "userIds": [1002623, 1002624, 1002622]   // 必填，1~N；N 的上限与 Damon 确认
}
```

**处理逻辑**

* 调用 YayChat 批量接口，写入/更新本地 `RechargeFeature`（按 `userId` 幂等更新 `features` 与 `lastSyncedAt`）
* 记录成功/失败项及错误信息到同步日志

**出参**

```json
{
  "code": 200,
  "msg": "ok",
  "data": {
    "total": 3,
    "success": 2,
    "failed": [
      { "userId": 1002624, "reason": "rate limited" }
    ],
    "taskId": "sync_20250903_001"     // 可选：便于后续查询日志
  }
}
```

### 4.2 批量查询用户充值特征（供前端展示）

**GET** `/recharge-features?userIds=1002623,1002624`
**权限**：登录用户（可选：限制仅能查与自己可见账号/转化相关的 `userId`）
**出参**

```json
{
  "code": 200,
  "msg": "ok",
  "data": [
    {
      "userId": 1002623,
      "features": { "isVip": true, "rechargeTotal": 120.5, "lastRechargeAt": "2025-09-02T10:00:00Z" },
      "lastSyncedAt": "2025-09-03T05:10:00Z",
      "source": "yaychat"
    },
    {
      "userId": 1002624,
      "features": null,                 // 若外部无数据
      "lastSyncedAt": "2025-09-03T05:10:12Z",
      "source": "yaychat"
    }
  ]
}
```

> **可选延伸接口（如需要）**
>
> * `GET /sync/tasks?taskId=&page=&pageSize=`：查看同步任务与失败明细
> * `POST /sync/recharge-features/retry`：重试失败的 `userIds`

---

## 5）数据模型参考（简化）

> 实际以数据库/Prisma 为准，此处便于前后端对齐字段语义

### 5.1 Account

```ts
{
  id: string;
  phoneNo: string;         // 唯一
  accountLink: string;     // URL
  ownerId: string;         // 用户ID（账号归属）
  createdBy: string;       // 创建人
  status: "ACTIVE" | "DISABLED";
  createdAt: string;       // ISO
}
```

### 5.2 Conversion

```ts
{
  id: string;
  registerUserId: number;  // YayChat侧注册ID（数值）
  accountId: string;
  phoneNo: string;         // 冗余一份便于查询
  createdBy: string;
  createdAt: string;
}
```

### 5.3 RechargeFeature

```ts
{
  id: string;
  userId: number;          // 对应 registerUserId（若两者非同一含义需建映射表）
  features: Record<string, any> | null; // 原样存储（JSON）
  lastSyncedAt: string;
  source: "yaychat";
}
```

### 5.4 AuditLog（建议）

```ts
{
  id: string;
  type: "ACCOUNT_CREATE" | "ACCOUNT_OWNER_CHANGE" | "SYNC_RUN" | "CONVERSION_CREATE";
  targetId: string;        // 账号ID/转化ID/任务ID
  before: any;
  after: any;
  operatorId: string;
  createdAt: string;
}
```

---

## 6）校验与幂等细则

* **创建账号**：`phoneNo` 唯一；冲突→`400`
* **提交转化**：`registerUserId + accountId` 幂等；重复提交→返回已存在（`duplicated=true`）
* **批量同步**：同一 `userId` 多次同步仅更新 `features/lastSyncedAt`；记录任务日志

---

## 7）安全与审计

* 所有接口需 `Authorization: Bearer <token>`
* 控制器层统一注入 `req.user` 并做 **角色 + 作用域过滤**
* 关键操作（账号创建、归属变更、转化提交、同步执行）写 **AuditLog**

---

## 8）示例 cURL

### 8.1 OP 提交账号

```bash
curl -X POST https://api.example.com/api/accounts \
  -H "Authorization: Bearer <token>" -H "Content-Type: application/json" \
  -d '{"phoneNo":"PH-0001","accountLink":"https://t.me/xxx"}'
```

### 8.2 OP 查询自己账号（模糊）

```bash
curl "https://api.example.com/api/accounts?q=0001&page=1&pageSize=20" \
  -H "Authorization: Bearer <token>"
```

### 8.3 转化提交（用 phoneNo 关联）

```bash
curl -X POST https://api.example.com/api/conversions \
  -H "Authorization: Bearer <token)" -H "Content-Type: application/json" \
  -d '{"registerUserId":1002623,"phoneNo":"PH-0001"}'
```

### 8.4 管理员批量同步充值特征

```bash
curl -X POST https://api.example.com/api/sync/recharge-features \
  -H "Authorization: Bearer <token>" -H "Content-Type: application/json" \
  -d '{"userIds":[1002623,1002624,1002622]}'
```

### 8.5 批量查询充值特征

```bash
curl "https://api.example.com/api/recharge-features?userIds=1002623,1002624" \
  -H "Authorization: Bearer <token>"
```

---

## 9）版本验收清单

* **v1.0**

  * `POST/GET/GET:id/PATCH:owner`（/accounts）全部可用，OP 仅见自有账号
* **v1.1**

  * `POST /conversions`（二选一关联），`GET /conversions`（模糊/筛选），`GET /conversions/:id`
  * CONVERTER 仅见自己提交
* **v1.2**

  * `POST /sync/recharge-features`、`GET /recharge-features`
  * 同步幂等、日志可查，账号/转化详情能展示最近同步结果

---

### 与 Damon 必须确认的要点

1. YayChat 批量接口字段定义（`features` 的结构、含义、示例）
2. 单次批量 userIds 上限、QPS、失败重试策略与错误码
3. `registerUserId` 与 YayChat `userId` 是否同一含义；若否，需要映射表与映射策略

> 需要的话，我可以把以上接口转成 **OpenAPI 3.0（YAML/JSON）** 草案，或输出 **Prisma Schema** 初稿，便于直接生成 Swagger 与数据库。
