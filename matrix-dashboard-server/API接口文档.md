# Matrix Dashboard Server API æ¥å£æ–‡æ¡£

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

- **é¡¹ç›®åç§°**: Matrix Dashboard Server
- **ç‰ˆæœ¬**: 1.0.0
- **åŸºç¡€URL**: `http://localhost:3000/api`
- **è®¤è¯æ–¹å¼**: Bearer Token (JWT)
- **åœ¨çº¿æ–‡æ¡£**: `http://localhost:3000/docs` (Swagger)

## ğŸ” è®¤è¯è¯´æ˜

### JWT Token ä½¿ç”¨
å¤§éƒ¨åˆ†æ¥å£éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ JWT Tokenï¼š
```
Authorization: Bearer <access_token>
```

### æƒé™ç³»ç»Ÿ
ç³»ç»Ÿé‡‡ç”¨ RBAC æƒé™æ¨¡å‹ï¼Œä¸åŒæ¥å£éœ€è¦ä¸åŒæƒé™ï¼š
- **è¶…çº§ç®¡ç†å‘˜ (admin)**: æ‹¥æœ‰æ‰€æœ‰æƒé™
- **è¿è¥äººå‘˜ (ops)**: è´¦å·ç®¡ç†ã€è½¬åŒ–æ•°æ®ã€å……å€¼ç®¡ç†ç­‰
- **æ•°æ®åˆ†æå¸ˆ (analyst)**: æ•°æ®æŸ¥çœ‹å’Œåˆ†ææƒé™
- **åªè¯»ç”¨æˆ· (viewer)**: ä»…æŸ¥çœ‹æƒé™

## ğŸ“š æ¥å£åˆ—è¡¨

### 1. å¥åº·æ£€æŸ¥æ¨¡å—

#### 1.1 å¥åº·æ£€æŸ¥
- **æ¥å£**: `GET /health`
- **æè¿°**: æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œæ•°æ®åº“è¿æ¥
- **æƒé™**: æ— éœ€è®¤è¯
- **å“åº”**:
```json
{
  "status": "ok",
  "timestamp": "2025-09-03T09:00:00.000Z",
  "uptime": 3600,
  "memory": {
    "rss": 50331648,
    "heapTotal": 20971520,
    "heapUsed": 15728640,
    "external": 1048576
  },
  "environment": "development"
}
```

### 2. è®¤è¯æ¨¡å— (Auth)

#### 2.1 è´¦å·å¯†ç ç™»å½•
- **æ¥å£**: `POST /auth/login`
- **æè¿°**: ç”¨æˆ·å/é‚®ç®± + å¯†ç ç™»å½•
- **æƒé™**: æ— éœ€è®¤è¯
- **è¯·æ±‚å‚æ•°**:
```json
{
  "username": "admin",     // ç”¨æˆ·åæˆ–é‚®ç®±
  "password": "admin123"   // å¯†ç  (æœ€å°‘6ä½)
}
```
- **å“åº”**:
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "user": {
      "id": 1,
      "username": "admin",
      "email": "admin@matrix.com",
      "nickname": "ç³»ç»Ÿç®¡ç†å‘˜",
      "avatar": null,
      "roles": [
        {
          "id": 1,
          "name": "è¶…çº§ç®¡ç†å‘˜",
          "code": "admin",
          "permissions": ["user:manage", "user:read", ...]
        }
      ]
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "d4a3af51-0d0a-409b-b279-44b2a3ddff67"
  }
}
```

#### 2.2 åˆ·æ–°è®¿é—®ä»¤ç‰Œ
- **æ¥å£**: `POST /auth/refresh`
- **æè¿°**: ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
- **æƒé™**: æ— éœ€è®¤è¯
- **è¯·æ±‚å‚æ•°**:
```json
{
  "refreshToken": "d4a3af51-0d0a-409b-b279-44b2a3ddff67"
}
```
- **å“åº”**: åŒç™»å½•æ¥å£

#### 2.3 ç™»å‡º
- **æ¥å£**: `POST /auth/logout`
- **æè¿°**: ç”¨æˆ·ç™»å‡ºï¼Œæ’¤é”€åˆ·æ–°ä»¤ç‰Œ
- **æƒé™**: éœ€è¦è®¤è¯
- **è¯·æ±‚å‚æ•°**:
```json
{
  "refreshToken": "d4a3af51-0d0a-409b-b279-44b2a3ddff67"
}
```
- **å“åº”**:
```json
{
  "code": 200,
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

#### 2.4 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- **æ¥å£**: `GET /auth/profile`
- **æè¿°**: è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
- **æƒé™**: éœ€è¦è®¤è¯
- **å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "id": 1,
    "username": "admin",
    "email": "admin@matrix.com",
    "nickname": "ç³»ç»Ÿç®¡ç†å‘˜",
    "avatar": null,
    "status": "active",
    "lastLoginAt": "2025-09-03T09:09:20.000Z",
    "roles": [...]
  }
}
```

#### 2.5 Lark ç›¸å…³æ¥å£

##### 2.5.1 è·å– Lark ç™»å½•æˆæƒ URL
- **æ¥å£**: `GET /auth/lark/url`
- **æè¿°**: è·å–é£ä¹¦ OAuth ç™»å½•é“¾æ¥
- **æƒé™**: æ— éœ€è®¤è¯
- **å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "authUrl": "https://passport.larksuite.com/suite/passport/oauth/authorize?..."
  }
}
```

##### 2.5.2 Lark OAuth å›è°ƒ
- **æ¥å£**: `GET /auth/lark/callback`
- **æè¿°**: é£ä¹¦ OAuth å›è°ƒå¤„ç†
- **æƒé™**: æ— éœ€è®¤è¯
- **æŸ¥è¯¢å‚æ•°**: `code`, `state`

##### 2.5.3 Lark æ‰«ç ç™»å½•
- **æ¥å£**: `POST /auth/lark/login`
- **æè¿°**: ä½¿ç”¨é£ä¹¦æˆæƒç ç™»å½•
- **æƒé™**: æ— éœ€è®¤è¯
- **è¯·æ±‚å‚æ•°**:
```json
{
  "code": "lark_authorization_code"
}
```

##### 2.5.4 ç»‘å®š Lark è´¦å·
- **æ¥å£**: `POST /auth/lark/bind`
- **æè¿°**: å°†å½“å‰ç”¨æˆ·ç»‘å®šåˆ°é£ä¹¦è´¦å·
- **æƒé™**: éœ€è¦è®¤è¯
- **è¯·æ±‚å‚æ•°**:
```json
{
  "code": "lark_authorization_code"
}
```

##### 2.5.5 è§£ç»‘ Lark è´¦å·
- **æ¥å£**: `POST /auth/lark/unbind`
- **æè¿°**: è§£ç»‘å½“å‰ç”¨æˆ·çš„é£ä¹¦è´¦å·
- **æƒé™**: éœ€è¦è®¤è¯

### 3. ç”¨æˆ·ç®¡ç†æ¨¡å— (User)

#### 3.1 åˆ›å»ºç”¨æˆ·
- **æ¥å£**: `POST /users`
- **æè¿°**: åˆ›å»ºæ–°ç”¨æˆ·
- **æƒé™**: `user:create`
- **è¯·æ±‚å‚æ•°**:
```json
{
  "username": "newuser",
  "email": "newuser@example.com",
  "password": "password123",
  "nickname": "æ–°ç”¨æˆ·",
  "avatar": "http://example.com/avatar.jpg"
}
```

#### 3.2 è·å–ç”¨æˆ·åˆ—è¡¨
- **æ¥å£**: `GET /users`
- **æè¿°**: åˆ†é¡µè·å–ç”¨æˆ·åˆ—è¡¨
- **æƒé™**: `user:read`
- **æŸ¥è¯¢å‚æ•°**:
  - `page`: é¡µç  (é»˜è®¤: 1)
  - `limit`: æ¯é¡µæ•°é‡ (é»˜è®¤: 10)
- **å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "users": [...],
    "total": 100,
    "page": 1,
    "limit": 10,
    "totalPages": 10
  }
}
```

#### 3.3 è·å–ç”¨æˆ·è¯¦æƒ…
- **æ¥å£**: `GET /users/:id`
- **æè¿°**: æ ¹æ®ç”¨æˆ·IDè·å–è¯¦ç»†ä¿¡æ¯
- **æƒé™**: `user:read`
- **è·¯å¾„å‚æ•°**: `id` - ç”¨æˆ·ID

#### 3.4 æ›´æ–°ç”¨æˆ·
- **æ¥å£**: `PATCH /users/:id`
- **æè¿°**: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- **æƒé™**: `user:update`
- **è·¯å¾„å‚æ•°**: `id` - ç”¨æˆ·ID
- **è¯·æ±‚å‚æ•°**:
```json
{
  "nickname": "æ›´æ–°çš„æ˜µç§°",
  "avatar": "http://example.com/new-avatar.jpg"
}
```

#### 3.5 åˆ é™¤ç”¨æˆ·
- **æ¥å£**: `DELETE /users/:id`
- **æè¿°**: è½¯åˆ é™¤ç”¨æˆ·
- **æƒé™**: `user:delete`
- **è·¯å¾„å‚æ•°**: `id` - ç”¨æˆ·ID

#### 3.6 ä¿®æ”¹å¯†ç 
- **æ¥å£**: `POST /users/change-password`
- **æè¿°**: å½“å‰ç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„å¯†ç 
- **æƒé™**: éœ€è¦è®¤è¯
- **è¯·æ±‚å‚æ•°**:
```json
{
  "oldPassword": "oldpass123",
  "newPassword": "newpass123"
}
```

#### 3.7 é‡ç½®ç”¨æˆ·å¯†ç 
- **æ¥å£**: `POST /users/:id/reset-password`
- **æè¿°**: ç®¡ç†å‘˜é‡ç½®æŒ‡å®šç”¨æˆ·å¯†ç 
- **æƒé™**: `user:update`
- **è·¯å¾„å‚æ•°**: `id` - ç”¨æˆ·ID
- **è¯·æ±‚å‚æ•°**:
```json
{
  "newPassword": "newpass123"
}
```

#### 3.8 åˆ†é…è§’è‰²
- **æ¥å£**: `POST /users/:id/roles`
- **æè¿°**: ä¸ºç”¨æˆ·åˆ†é…è§’è‰²
- **æƒé™**: `user:update`
- **è·¯å¾„å‚æ•°**: `id` - ç”¨æˆ·ID
- **è¯·æ±‚å‚æ•°**:
```json
{
  "roleIds": [1, 2, 3]
}
```

#### 3.9 æ›´æ–°ç”¨æˆ·çŠ¶æ€
- **æ¥å£**: `PATCH /users/:id/status`
- **æè¿°**: æ›´æ–°ç”¨æˆ·çŠ¶æ€ (active/inactive/banned)
- **æƒé™**: `user:update`
- **è·¯å¾„å‚æ•°**: `id` - ç”¨æˆ·ID
- **è¯·æ±‚å‚æ•°**:
```json
{
  "status": "inactive"
}
```

#### 3.10 è·å–ç”¨æˆ·æƒé™
- **æ¥å£**: `GET /users/:id/permissions`
- **æè¿°**: è·å–ç”¨æˆ·çš„æ‰€æœ‰æƒé™åˆ—è¡¨
- **æƒé™**: `user:read`
- **è·¯å¾„å‚æ•°**: `id` - ç”¨æˆ·ID

### 4. è§’è‰²ç®¡ç†æ¨¡å— (RBAC - Role)

#### 4.1 åˆ›å»ºè§’è‰²
- **æ¥å£**: `POST /roles`
- **æè¿°**: åˆ›å»ºæ–°è§’è‰²
- **æƒé™**: `role:create`
- **è¯·æ±‚å‚æ•°**:
```json
{
  "name": "æ–°è§’è‰²",
  "code": "new_role",
  "description": "è§’è‰²æè¿°",
  "sort": 10
}
```

#### 4.2 è·å–è§’è‰²åˆ—è¡¨
- **æ¥å£**: `GET /roles`
- **æè¿°**: è·å–æ‰€æœ‰è§’è‰²åˆ—è¡¨
- **æƒé™**: `role:read`

#### 4.3 è·å–è§’è‰²è¯¦æƒ…
- **æ¥å£**: `GET /roles/:id`
- **æè¿°**: æ ¹æ®è§’è‰²IDè·å–è¯¦ç»†ä¿¡æ¯
- **æƒé™**: `role:read`
- **è·¯å¾„å‚æ•°**: `id` - è§’è‰²ID

#### 4.4 æ›´æ–°è§’è‰²
- **æ¥å£**: `PATCH /roles/:id`
- **æè¿°**: æ›´æ–°è§’è‰²ä¿¡æ¯
- **æƒé™**: `role:update`
- **è·¯å¾„å‚æ•°**: `id` - è§’è‰²ID

#### 4.5 åˆ é™¤è§’è‰²
- **æ¥å£**: `DELETE /roles/:id`
- **æè¿°**: åˆ é™¤è§’è‰²
- **æƒé™**: `role:delete`
- **è·¯å¾„å‚æ•°**: `id` - è§’è‰²ID

#### 4.6 ä¸ºè§’è‰²æ·»åŠ æƒé™
- **æ¥å£**: `POST /roles/:id/permissions`
- **æè¿°**: ä¸ºè§’è‰²åˆ†é…æƒé™
- **æƒé™**: `role:update`
- **è·¯å¾„å‚æ•°**: `id` - è§’è‰²ID
- **è¯·æ±‚å‚æ•°**:
```json
{
  "permissionIds": [1, 2, 3, 4, 5]
}
```

#### 4.7 ç§»é™¤è§’è‰²æƒé™
- **æ¥å£**: `DELETE /roles/:id/permissions`
- **æè¿°**: ç§»é™¤è§’è‰²çš„æŒ‡å®šæƒé™
- **æƒé™**: `role:update`
- **è·¯å¾„å‚æ•°**: `id` - è§’è‰²ID
- **è¯·æ±‚å‚æ•°**:
```json
{
  "permissionIds": [1, 2, 3]
}
```

### 5. æƒé™ç®¡ç†æ¨¡å— (RBAC - Permission)

#### 5.1 åˆ›å»ºæƒé™
- **æ¥å£**: `POST /permissions`
- **æè¿°**: åˆ›å»ºæ–°æƒé™
- **æƒé™**: `permission:create`
- **è¯·æ±‚å‚æ•°**:
```json
{
  "name": "æƒé™åç§°",
  "code": "permission:code",
  "type": "api",
  "description": "æƒé™æè¿°",
  "parentId": null,
  "resource": "GET:/api/example",
  "sort": 1
}
```

#### 5.2 è·å–æƒé™åˆ—è¡¨
- **æ¥å£**: `GET /permissions`
- **æè¿°**: è·å–æƒé™åˆ—è¡¨ï¼Œæ”¯æŒæ ‘å½¢ç»“æ„
- **æƒé™**: `permission:read`
- **æŸ¥è¯¢å‚æ•°**:
  - `tree`: æ˜¯å¦è¿”å›æ ‘å½¢ç»“æ„ (true/false)

#### 5.3 è·å–æƒé™è¯¦æƒ…
- **æ¥å£**: `GET /permissions/:id`
- **æè¿°**: æ ¹æ®æƒé™IDè·å–è¯¦ç»†ä¿¡æ¯
- **æƒé™**: `permission:read`
- **è·¯å¾„å‚æ•°**: `id` - æƒé™ID

#### 5.4 æ›´æ–°æƒé™
- **æ¥å£**: `PATCH /permissions/:id`
- **æè¿°**: æ›´æ–°æƒé™ä¿¡æ¯
- **æƒé™**: `permission:update`
- **è·¯å¾„å‚æ•°**: `id` - æƒé™ID

#### 5.5 åˆ é™¤æƒé™
- **æ¥å£**: `DELETE /permissions/:id`
- **æè¿°**: åˆ é™¤æƒé™
- **æƒé™**: `permission:delete`
- **è·¯å¾„å‚æ•°**: `id` - æƒé™ID

#### 5.6 æ ¹æ®çˆ¶çº§IDè·å–æƒé™åˆ—è¡¨
- **æ¥å£**: `GET /permissions/parent/:parentId`
- **æè¿°**: è·å–æŒ‡å®šçˆ¶çº§æƒé™ä¸‹çš„å­æƒé™åˆ—è¡¨
- **æƒé™**: `permission:read`
- **è·¯å¾„å‚æ•°**: `parentId` - çˆ¶çº§æƒé™ID

## ğŸ”§ é”™è¯¯ç è¯´æ˜

### HTTP çŠ¶æ€ç 
- `200`: è¯·æ±‚æˆåŠŸ
- `201`: åˆ›å»ºæˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401`: æœªè®¤è¯æˆ–è®¤è¯å¤±è´¥
- `403`: æƒé™ä¸è¶³
- `404`: èµ„æºä¸å­˜åœ¨
- `409`: èµ„æºå†²çª (å¦‚ç”¨æˆ·åå·²å­˜åœ¨)
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### ä¸šåŠ¡é”™è¯¯ç 
æ‰€æœ‰æ¥å£è¿”å›æ ¼å¼ç»Ÿä¸€ä¸ºï¼š
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {}
}
```

é”™è¯¯å“åº”æ ¼å¼ï¼š
```json
{
  "message": "é”™è¯¯æè¿°",
  "error": "é”™è¯¯ç±»å‹",
  "statusCode": 400
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è·å–è®¿é—®ä»¤ç‰Œ
```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

### 2. ä½¿ç”¨ä»¤ç‰Œè®¿é—®å—ä¿æŠ¤æ¥å£
```bash
curl -X GET http://localhost:3000/api/auth/profile \
  -H "Authorization: Bearer <your_access_token>"
```

### 3. è·å–ç”¨æˆ·åˆ—è¡¨
```bash
curl -X GET "http://localhost:3000/api/users?page=1&limit=10" \
  -H "Authorization: Bearer <your_access_token>"
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Token è¿‡æœŸ**: Access Token é»˜è®¤æœ‰æ•ˆæœŸä¸º 1 å°æ—¶ï¼ŒRefresh Token æœ‰æ•ˆæœŸä¸º 7 å¤©
2. **æƒé™éªŒè¯**: å¤§éƒ¨åˆ†æ¥å£éƒ½éœ€è¦ç›¸åº”çš„æƒé™ï¼Œè¯·ç¡®ä¿ç”¨æˆ·å…·æœ‰è¶³å¤Ÿçš„æƒé™
3. **å‚æ•°éªŒè¯**: æ‰€æœ‰è¯·æ±‚å‚æ•°éƒ½ä¼šè¿›è¡Œä¸¥æ ¼éªŒè¯ï¼Œè¯·æŒ‰ç…§æ–‡æ¡£æ ¼å¼ä¼ é€’å‚æ•°
4. **åˆ†é¡µæŸ¥è¯¢**: æ”¯æŒåˆ†é¡µçš„æ¥å£éƒ½æœ‰é»˜è®¤çš„ page å’Œ limit å‚æ•°
5. **è½¯åˆ é™¤**: ç”¨æˆ·åˆ é™¤é‡‡ç”¨è½¯åˆ é™¤æ–¹å¼ï¼Œæ•°æ®ä¸ä¼šçœŸæ­£åˆ é™¤

## ğŸ”— ç›¸å…³é“¾æ¥

- **Swagger æ–‡æ¡£**: http://localhost:3000/docs
- **å¥åº·æ£€æŸ¥**: http://localhost:3000/api/health
- **é¡¹ç›®ä»“åº“**: [GitHub Repository]

---

**æ›´æ–°æ—¶é—´**: 2025-09-03  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**è”ç³»æ–¹å¼**: Matrix Team